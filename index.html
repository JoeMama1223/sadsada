<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>test</title>
    </head>
    <script src="pixi.min.js"></script>
    <script src="pam.js"></script>
    <script src="js/bytebuffer.js"></script>
    <script src="js/pamparse.js"></script>
    <script src="js/rtonparse.js"></script>
    <script src="pvz2util.js"></script>
    <body>
<script type="text/javascript">

    PVZ2.setResolution(768)
    let app = new PIXI.Application({width: PVZ2.screenHeight, height: PVZ2.screenWidth});
    document.body.appendChild(app.view);
    // PVZ2.collisionBox = true

    app.renderer.backgroundColor = 0x0ccccff;   

    const loader = PIXI.Loader.shared;
    loadPams()

    let sun1
    let selspr

    var seedChooser
    var scene
    PVZ2.gameStart = false
    PVZ2.debug = false
    var shovelPos = {x: 1060, y: 1060, width: 125, height: 125}
    var seedBank = {
        initSeeds: ['sunflower', 'peashooter', 'wallnut', 'snowpea', 'cherry_bomb'],
        seeds: [],
        pos: {
            x: 0, y: 150, height: 120, width: 180
        },
        next() {    // return the next available empty seed, or undefined if full
            for(let seed of this.seeds) {
                if(!seed.type) {
                    return seed
                }
            }
        }
    }
    var zombieBank = {
        packets: ['mummy_armor4', 'mummy_armor1', 'mummy_armor2', 'mummy'],
        pos: {
            x: 1800, y: 400, height: 600, width: 280
        },
        zombies: [],
        shuffle() {
            this.packets = []
            let types = rtons.PropertySheets.DefaultGameProps.ZombieAlmanacOrder
            for(let i = 0;i < 4;i++) {
                this.packets.push(types[rnd(0, types.length - 1)])
            }
            this.showDemo()
        },
        showDemo() {
            let need = this.packets.filter(p => rtons.ZombieTypes[p])
            if(need.length > 0) {
                loadZombieResource(need, () => {
                    this.showDemo2()
                })
            } else {
                this.showDemo2()
            }
        },
        showDemo2() {
            for(let z of this.zombies) {
                scene.removeChild(z)
            }
            this.zombies = []
            for(let i = 0;i < 2;i++) {
                for(let p of this.packets) {
                    let demo = new PVZ2.ZombieBaseClass(rtons.ZombieTypes[p], 'idle')
                    demo.position.set(this.pos.x + rnd(0, this.pos.width), this.pos.y + rnd(0, this.pos.height))
                    scene.addChild(demo)
                    demo.zIndex = demo.y
                    objects.push(demo)
                    this.zombies.push(demo)
                }
            }
            zombieBank.buttonRefresh.texture = texturesMap.IMAGE_UI_POWERUPS_POWER_BEGHOULEDSHUFFLE
            zombieBank.buttonRefresh.interactive = true
        }
    }

    function init() {
        initGrid(5, 9)
        scene = back(0, 0)
        scene.goBack()
        for(let i = 0;i < 8;i++){
            seedBank.seeds.push(seed(-1, 0, seedBank.pos.height * i + seedBank.pos.y))
        }
        for(let i = 0;i < 5;i++) {
            drawPam(310, i * 150 + 390, pams.POPANIM_MOWERS_MOWER_MODERN, undefined, 'car', scene)
        }
        // sun1 = sun(500, 100)
        selspr = seedSel(0, 100)
        selspr.visible = false
        numSun(0, 0, 50)
        shovel(shovelPos.x, shovelPos.y)

        sunTotal = 5000
        // seed chooser & bank
        seedChooser = new SeedChooser(5, 5)
        stage.addChild(seedChooser)
        seedChooser.position.set(seedBank.pos.width + 20, 440)
        loadPlantResource(seedBank.initSeeds, () => {
            seedChooser.click2(0, 0)
            // zombie random packet & bank
            zombieBank.showDemo()
        })
        for(let [index, name] of seedBank.initSeeds.entries()) {
            seedChooser.addSeedByName(name)
        }

        // start button
        let buttonStart = drawPImage(1140, 940, texturesMap.IMAGE_UI_GENERIC_PURPLEBUTTON, stage)
        let buttonStartText = new PIXI.Text('Start!', { fontFamily: 'Arial', fontSize: 56, fill: 'white', align: 'center', fontWeight: '600', strokeThickness: 3 });
        buttonStartText.position.set(buttonStart.x + 13, buttonStart.y + 15)
        stage.addChild(buttonStartText)

        buttonStart.interactive = true
        buttonStart.click = function() {
            PVZ2.gameStart = true
            stage.removeChild(seedChooser)
            stage.removeChild(zombieBank.buttonRefresh)
            stage.removeChild(buttonStart, buttonStartText)
            scene.goFront()
        }
        // refresh button
        zombieBank.buttonRefresh = drawPImage(1000, 300, texturesMap.IMAGE_UI_POWERUPS_POWER_BEGHOULEDSHUFFLE, stage)
        zombieBank.buttonRefresh.interactive = true
        zombieBank.buttonRefresh.click = function() {
            zombieBank.shuffle()
            zombieBank.buttonRefresh.texture = texturesMap.IMAGE_UI_POWERUPS_POWER_BEGHOULEDSHUFFLE_DOWN
            zombieBank.buttonRefresh.interactive = false
        }
    }
    t = 0
    var speed = 2
    var sunCnt = 0
    var zombieCnt = 0

    function loop() {
        if(t++ % speed == 0) {
            for(let obj of objects) {
                if(obj.ztype == 'sun') {
                    
                } else if(obj.ztype == 'seed') {
                    
                } else if(obj.ztype == 'plant') {
                    
                } else if(obj.ztype == 'zombie') {
                    
                } else if(obj.ztype == 'seedSel') {
                    obj.visible = (selPlant != -1)
                    obj.y = selPlant * seedBank.pos.height + seedBank.pos.y
                } else if(obj.ztype == 'effect') {
                    
                } else if(obj.ztype == 'projectile') {
                }
                obj.step()
            }
            if(!PVZ2.gameStart) return
            // a new sun every 20 sec
            sunCnt++
            if(sunCnt == 300) {
                sunCnt = 0
                sun(field.x + rnd(0, 800), 0)
            }
            if(++zombieCnt > 200) {
                zombieCnt = 0
                let type = rtons.ZombieTypes[rndObj(zombieBank.packets)]
                zombie(type, 1700, (rnd(0, 4) + 0.5) * field.h + field.y)
            }
        }
    }

    let selPlant = -1
    let useShovel = false
    let field = {
        x: 406, y: 312,
        w: 128, h: 150
    }

    function onclick(e) {
        let x = e.offsetX / PVZ2.zoom, y = e.offsetY / PVZ2.zoom
        console.log('click: ', x, y)

        if(!PVZ2.gameStart) {
            if(x >= seedChooser.x && y > seedChooser.y) {
                seedChooser.click(x - seedChooser.x, y - seedChooser.y)
            }
            // click seedbank to cancel
            if(x < seedBank.pos.width) {
                let dy = (y - seedBank.pos.y) / seedBank.pos.height
                let dy2 = Math.floor(dy)
                if(dy2 >= 0 && dy2 < 8) {
                    let seed = seedBank.seeds[dy2]
                    if(seed.type) {
                        seedChooser.setPicked(seed.type.TypeName, false)
                        seed.clearType()
                    }
                }
            }
            return
        }

        // if(x > 1200) {
        //     let a = zombie(selPlant, x, y)
        //     return
        // }

        // collect sun
        for(let obj of objects) {
            if(obj.ztype == 'sun') {
                let dis = Math.sqrt((obj.x - x)**2 + (obj.y - y)**2)
                if(dis <= 50) {
                    rm(obj)
                    sunTotal += 25
                    return
                }
            }
        }
        // plant plant
        dx = x - field.x
        dy = y - field.y
        dx2 = Math.floor(dx / field.w)
        dy2 = Math.floor(dy / field.h)
        if(dx2 >= 0 && dx2 < 9 && dy2 >= 0 && dy2 < 5) {
            if(PVZ2.grids[dy2][dx2]) {
                if(useShovel) {
                    rm(PVZ2.grids[dy2][dx2])
                    PVZ2.grids[dy2][dx2] = 0
                    useShovel = false
                }
            } else if(selPlant != -1) {
                let seed = seedBank.seeds[selPlant]
                let p = PVZ2.grids[dy2][dx2] = plant(seed.type, field.x + (0.5 + dx2) * field.w, field.y + (0.5 + dy2) * field.h)
                p.gridX = dx2
                p.gridY = dy2
                
                let cost = seed.type.prop.Cost
                sunTotal -= cost
                seed.use()    // cooldown
                selPlant = -1
            }
        }
        // pick plant
        if(x < seedBank.pos.width) {
            let dy = (y - seedBank.pos.y) / seedBank.pos.height
            let dy2 = Math.floor(dy)
            if(dy2 >= 0 && dy2 < 8) {
                if(dy2 == selPlant){
                    selPlant = -1
                } else {
                    let seed = seedBank.seeds[dy2]
                    if(seed.type) {
                        let cost = seed.type.prop.Cost
                        if(sunTotal >= cost && seed.ready()) {
                            selPlant = dy2
                            useShovel = false
                        }
                    }
                }
            }
        }
        // toggle shovel
        if(x <= shovelPos.x + shovelPos.width && x >= shovelPos.x && y <= shovelPos.y + shovelPos.height && y >= shovelPos.y){
            useShovel = !useShovel
            selPlant = -1
        }
    }
    
    window.onkeydown = function(e) {
        if(e.code == 'KeyA'){
            speed = 60
        }
        if(e.code == 'KeyR'){
            speed = 2
        }
        if(e.code == 'KeyU'){
            seedChooser.pageUp()
        }
        if(e.code == 'KeyD'){
            seedChooser.pageDown()
        }
    }
    

    var plantList = []

    var zombieList = []

    function rnd(x, y) {
        return Math.floor(Math.random() * (y-x+1)) + x
    }
    function rndObj(arr) {
        return arr[Math.floor(Math.random() * arr.length)]
    }
    app.view.onclick = onclick
</script>
    </body>
</html>