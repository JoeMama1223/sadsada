<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>test</title>
    </head>
    <script src="pixi.min.js"></script>
    <script src="pam.js"></script>
    <script src="js/bytebuffer.js"></script>
    <script src="js/pamparse.js"></script>
    <script src="js/rtonparse.js"></script>
    <script src="pvz2util.js"></script>
    <body>
<script type="text/javascript">

    PVZ2.setResolution(768)
    let app = new PIXI.Application({width: PVZ2.screenHeight, height: PVZ2.screenWidth});
    document.body.appendChild(app.view);
    PVZ2.collisionBox = true

    app.renderer.backgroundColor = 0x0ccccff;   

    const loader = PIXI.Loader.shared;
    loadPams()

    let sun1
    let selspr
    var seeds = []
    var grids = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
    ]

    var seedChooser
    var gameStart = true
    var seedBankPos = {x: 0, y: 150, height: 120, width: 160}
    var shovelPos = {x: 1060, y: 1060, width: 125, height: 125}

    function init() {
        back(0, 0)
        for(let i = 0;i < 8;i++){
            seeds.push(seed(i, 0, seedBankPos.height * i + seedBankPos.y))
        }
        for(let seed of seeds) {seed.refresh()} // for test
        for(let i = 0;i < 5;i++) {
            car(310, i * 150 + 390)
        }
        sun1 = sun(500, 100)
        selspr = seedSel(0, 100)
        selspr.visible = false
        numSun(0, 0, 50)
        shovel(shovelPos.x, shovelPos.y)

        sunTotal = 500
        // seedChooser = new SeedChooser(5)
        // stage.addChild(seedChooser)
        // seedChooser.position.set(100, 0)
    }
    t = 0
    var speed = 2
    var sunCnt = 0

    function loop() {
        // if(!gameStart) return
        if(t++ % speed == 0) {
            for(let obj of objects) {
                if(obj.ztype == 'sun') {
                    
                } else if(obj.ztype == 'seed') {
                    
                } else if(obj.ztype == 'plant') {
                    
                } else if(obj.ztype == 'zombie') {
                    
                } else if(obj.ztype == 'seedSel') {
                    obj.visible = (selPlant != -1)
                    obj.y = selPlant * seedBankPos.height + seedBankPos.y
                } else if(obj.ztype == 'effect') {
                    
                } else if(obj.ztype == 'projectile') {
                    for(let obj2 of objects) {
                        if(obj2.ztype == 'zombie' && !obj2.dead) {
                            if(ifCollide(obj, obj2, obj.type.CollisionRect, obj2.type.prop.HitRect)) {
                                obj2.hit(obj.type.BaseDamage)
                                if(obj2.hitpoints > 0) {
                                    if(obj.type.Conditions) {
                                        for(let cond of obj.type.Conditions) {
                                            if(cond.Condition == 'chill') {
                                                obj2.chill(cond.Duration.Min)
                                            }
                                        }
                                    }
                                }
                                obj.splat()
                                rm(obj)            
                            }
                        }
                    }
                }
                obj.step()
            }
            // a new sun every 20 sec
            sunCnt++
            if(sunCnt == 300) {
                sunCnt = 0
                sun(field.x + rnd(0, 800), 0)
            }
        }
    }

    let selPlant = -1
    let useShovel = false
    let field = {
        x: 406, y: 312,
        w: 128, h: 150
    }

    function onclick(e) {
        let x = e.offsetX / PVZ2.zoom, y = e.offsetY / PVZ2.zoom
        console.log('click: ', x, y)

        if(!gameStart) {
            if(x >= seedChooser.x && y > seedChooser.y) {
                seedChooser.click(x - seedChooser.x, y - seedChooser.y)
            }
            return
        }

        if(x > 1200) {
            let a = zombie(selPlant, x, y)
            return
        }

        dx = x - field.x
        dy = y - field.y
        dx2 = Math.floor(dx / field.w)
        dy2 = Math.floor(dy / field.h)
        if(dx2 >= 0 && dx2 < 9 && dy2 >= 0 && dy2 < 5) {
            if(grids[dy2][dx2]) {
                if(useShovel) {
                    rm(grids[dy2][dx2])
                    grids[dy2][dx2] = 0
                    useShovel = false
                }
            } else if(selPlant != -1) {
                grids[dy2][dx2] = plant(selPlant, field.x + (0.5 + dx2) * field.w, field.y + (0.5 + dy2) * field.h)
                
                let cost = plantList[selPlant].prop.Cost
                sunTotal -= cost
                seeds[selPlant].use()    // cooldown
                selPlant = -1
            }
        }
        // pick plant
        if(x < seedBankPos.width) {
            let dy = (y - seedBankPos.y) / seedBankPos.height
            let dy2 = Math.floor(dy)
            if(dy2 >= 0 && dy2 < 8) {
                let cost = plantList[dy2].prop.Cost
                if(sunTotal >= cost && seeds[dy2].ready()) {
                    selPlant = dy2
                    useShovel = false
                }
            }
        }
        // collect sun
        for(let obj of objects) {
            if(obj.ztype == 'sun') {
                let dis = Math.sqrt((obj.x - x)**2 + (obj.y - y)**2)
                if(dis <= 50) {
                    rm(obj)
                    sunTotal += 25
                    break
                }
            }
        }
        // toggle shovel
        if(x <= shovelPos.x + shovelPos.width && x >= shovelPos.x && y <= shovelPos.y + shovelPos.height && y >= shovelPos.y){
            useShovel = !useShovel
            selPlant = -1
        }
    }
    
    window.onkeydown = function(e) {
        if(e.code == 'KeyA'){
            speed = 60
        }
        if(e.code == 'KeyR'){
            speed = 2
        }
    }
    

    var plantList = [
        {       // 0
            ename: 'sunflower',
            cost: 50,
            hitpoint: 300,
            cooldown: 20,
        },
        {       // 1
            ename: 'peashooter',
        },
        {       // 2
            ename: 'wallnut',
        },
        {       // 3
            ename: 'snowpea',
        },
        {       // 4
            ename: 'chomper',
        },
        {       // 5
            ename: 'squash',
        },
        {       // 6
            ename: 'cherry_bomb',
        },
        {       // 7
            ename: 'repeater',
        },
        {       // 8
            ename: 'threepeater',
        },
        {       // 9
            ename: 'fumeshroom',
        },
    ]

    var zombieList = [
        {       // 0
            ename: 'mummy',
        },
        {       // 0
            ename: 'mummy_armor1',
        },
        {       // 0
            ename: 'mummy_armor2',
        },
        {       // 0
            ename: 'mummy_armor4',
        },
        {       // 0
            ename: 'modern_allstar',
        },
    ]

    function rnd(x, y) {
        return Math.floor(Math.random() * (y-x+1)) + x
    }
    app.view.onclick = onclick
</script>
    </body>
</html>