<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>PVZ2</title>
    </head>
    <script src="pixi.min.js"></script>
    <script src="pam.js"></script>
    <body>
        <script type="text/javascript">
           


    //Create a Pixi Application
    let app = new PIXI.Application({width: 916, height: 800});
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    app.renderer.backgroundColor = 0x0ccccff;
    const loader = PIXI.Loader.shared;
    PIXI.Sprite.prototype.change = function(texture) {
        this.texture = texture
    }
    PIXI.DisplayObject.prototype.turn = function(d) {
        this.angle += d
    }
    PIXI.DisplayObject.prototype.move = function(x, y) {
        this.x += x
        this.y += y
    }
    PIXI.DisplayObject.prototype.moveTo = function(x, y) {
        this.x = x
        this.y = y
    }
    const pamList = [
        {
            name: ['SUNFLOWER'],
            image: 'PlantSunflower_768_00'
        },
        {
            name: ['PEASHOOTER'],
            image: 'PLANTPEASHOOTER_768_00'
        },
        {
            name: ['SNOWPEA', 'SNOWPEA_PLANTFOOD', 'T_SNOW_PEA'],
            image: 'PLANTSNOWPEA_768_00'
        },
        {
            name: ['CHERRYBOMB', 'CHERRYBOMB_EXPLOSION_TOP', 'CHERRYBOMB_EXPLOSION_REAR'],
            image: 'PLANTCHERRYBOMB_768_00'
        },
        {
            name: ['SUNFLOWER_TWIN'],
            image: 'PLANTTWINSUNFLOWER_768_00'
        },
        {
            name: ['THREEPEATER'],
            image: 'PLANTTHREEPEATER_768_00'
        },
        {
            name: ['SQUASH'],
            image: 'PLANTSQUASH_768_00'
        },
        {
            name: ['ZOMBIE_MODERN_ALLSTAR'],
            image: 'ZOMBIEMODERNALLSTARGROUP_768_00'
        },
        {
            name: ['ZOMBIE_EGYPT_BASIC'],
            image: 'ZombieEgyptBasicGroup_768_00'
        },
        {
            name: ['COCONUTCANNON', 'T_COCONUT_PROJECTILE_EXPLOSION'],
            image: 'PlantCoconutCannon_768_00'
        },
        {
            name: ['FUMESHROOM', 'FUMESHROOM_BUBBLES', 'FUMESHROOM_BUBBLES_HIT'],
            image: 'PLANTFUMESHROOM_768_00'
        },
        {
            name: ['BLOOMERANG', 'T_BLOOMERANG_PROJECTILE'],
            image: 'PlantBloomerang_768_00'
        },
        {
            name: ['BONKCHOY'],
            image: 'PLANTBONKCHOY_768_00'
        },
        {
            name: ['GARGANTUAR'],
            image: 'ZOMBIEFUTUREGARGANTUARGROUP_768_00'
        },
        {
            name: ['SNAPDRAGON', 'SNAPDRAGON_FIRE'],
            image: 'PlantSnapdragon_768_00'
        },
        {
            name: [],
            image: ['DelayLoad_Background_FrontLawn_768_00', 'Grass_Transition_768_00', 'UI_SeedPackets_768_00']
        },
        {
            name: ['T_PEA_PROJECTILE'],
            image: 'PEAEFFECTS_768_00'
        },
        {
            name: ['ZOMBIE_ASH', 'T_SPLAT_SNOW_PEA', 'SUN'],
            image: 'levelcommon_768_00'
        },
        {
            name: ['SODROLL'],
            image: 'SodRollGroup_768_00'
        }
    ]
    for(let p of pamList) {
        for(let name of p.name) {
            loader.add(name, "pam/pams/" + name + ".json")
        }
        if(typeof p.image == 'string') {
            loader.add(p.image, "pam/json/" + p.image + ".json")
        } else {
            for(let i of p.image) {
                loader.add(i, "pam/json/" + i + ".json")
            }
        }
    }
    loader.load((loader, resources) => setup(resources));
    
    function add(texture, x, y) {
        let s = new PIXI.Sprite(texture);
        s.x = x
        s.y = y
        stage.addChild(s);
        return s
    }

    let objects = []
    let grass, sod
    let stage = new PIXI.Container()
    function setup(resources) {
        app.stage.addChild(stage)
        stage.scale.set(768 / 1200)
        for(let p of pamList) {
            for(let name of p.name) {
                if(resources[name].data) {
                    let textures = {}
                    if(typeof p.image == 'string') {
                        textures = resources[p.image].textures
                    } else {
                        for(let i of p.image) {
                            Object.assign(textures, resources[i].textures)
                        }
                    }
                    pamInit(name, resources[name].data, textures)
                }
            }
        }
        let bg = new PIXI.Container()
        stage.addChild(bg)
        let bg2 = new PIXI.Sprite(resources.DelayLoad_Background_FrontLawn_768_00.textures.IMAGE_BACKGROUNDS_FRONTLAWN_TEXTURE)
        bg2.position.set(0, 0)
        let bgSod = new PIXI.Sprite(resources.DelayLoad_Background_FrontLawn_768_00.textures.IMAGE_BACKGROUNDS_FRONTLAWN_ROW_03)
        bgSod.position.set(253, 285)
        grass = new PIXI.TilingSprite(resources.Grass_Transition_768_00.textures.IMAGE_TRANSITION_GRASSTILE, 0, 140)
        grass.position.set(253, 587)
        grass.scale.set(0.706)
        grass.tilePosition.set(40, -70)
        grass2 = new PIXI.TilingSprite(resources.Grass_Transition_768_00.textures.IMAGE_TRANSITION_GRASSTILE, 0, 140)
        grass2.position.set(253, 200)
        grass2.scale.set(0.706)
        grass2.tilePosition.set(40, -70)
        bg.addChild(bg2, bgSod, grass, grass2)
        
        bg.scale.set(1200 / 768)
        bg.position.set(-200, -250)

        sod = addPam(pams.SODROLL, '', bg.x + 400, bg.y + 685)
        sod2 = addPam(pams.SODROLL, '', bg.x + 400, bg.y + 85)


        addPam(pams.PEASHOOTER, 'idle', 0, -50, {custom: 'custom_06'})
        // addPam(pams.PEASHOOTER, 'attack', 0, 100)
        addPam(pams.PEASHOOTER, 'attack', -50, 80, {custom: 'custom_04', userAction: function(pamSprite) {
            let shot = addPam(pams.T_PEA_PROJECTILE, 'animation', pamSprite.x + 40, pamSprite.y - 60)
            shot.stepAction = function() {
                this.x += 10
                if(this.x > 800) {
                    this.needRemove = true
                }
            }
        }})
        addPam(pams.SUNFLOWER, 'special', 110, -50, {custom: 'custom_03', userAction: function(pamSprite) {
            let sun = addPam(pams.SUN, '', pamSprite.x + 80, pamSprite.y - 0)
            sun.drop = 0
            sun.stepAction = function() {
                this.drop++
                this.y += 3
                if(this.drop > 60) {
                    this.needRemove = true
                }
            }
        }})
        addPam(pams.SNOWPEA, 'attack', 240, -50, {custom: 'custom_01', userAction: function(pamSprite) {
            let shot = addPam(pams.T_SNOW_PEA, '', pamSprite.x + 80, pamSprite.y - 30)
            shot.stepAction = function() {
                this.x += 10
                if(this.x > 800) {
                    this.needRemove = true
                }
            }
        }})

        let cherry = addPam(pams.CHERRYBOMB, 'idle', 230, 80, {onFinish: function(pamSprite) {
            if(pamSprite.attack) {
                pamSprite.visible = false
                let offsetX = 24, offsetY = -180
                addPam(pams.CHERRYBOMB_EXPLOSION_REAR, '', pamSprite.x + offsetX, pamSprite.y + offsetY, {onFinish: onFinish})
                addPam(pams.CHERRYBOMB_EXPLOSION_TOP, '', pamSprite.x + offsetX, pamSprite.y + offsetY, {onFinish: onFinish})
                zombie.visible = false
                addPam(pams.ZOMBIE_ASH, '', zombie.x, zombie.y, {onFinish: onFinish})
                if(zombie2.x < pamSprite.x + 150 && zombie2.x > pamSprite.x - 200) {
                    zombie2.visible = false
                    addPam(pams.ZOMBIE_ASH, '', zombie2.x, zombie2.y, {onFinish: onFinish})
                }
                pamSprite.cherryWait = cherryWaitIdle + 100
            }
        }})
        let cherryWaitIdle = 50
        cherry.attack = false
        cherry.cherryWait = cherryWaitIdle
        cherry.stepAction = function() {
            this.cherryWait--
            if(this.cherryWait == cherryWaitIdle) {
                if(!zombie2.visible) {
                    zombie2.x = 600
                    zombie2.visible = true
                }
                zombie.x = 900
                zombie.visible = true
                this.changeAction(this.pam.actionFrame['idle'])
                this.visible = true
                this.attack = false
            }
            if(zombie.x < this.x + 200) {
                if(!this.attack) {
                    this.changeAction(this.pam.actionFrame['attack'])
                    this.attack = true
                }
                
            }
        }
        addPam(pams.SUNFLOWER_TWIN, 'idle', 380, -50)
        addPam(pams.THREEPEATER, 'idle', 370, 80)
        addPam(pams.SQUASH, 'idle', 80, 80)

        addPam(pams.BONKCHOY, 'idle', 150, 240)

        addPam(pams.BLOOMERANG, 'attack', -50, 240, {userAction: function(pamSprite) {
            let shot = addPam(pams.T_BLOOMERANG_PROJECTILE, '', pamSprite.x + 100, pamSprite.y - 60)
            shot.forward = true
            shot.stepAction = function() {
                if(shot.forward) {
                    this.x += 15
                    if(this.x > 700) {
                        this.y -= 20
                        this.forward = false
                    }
                } else {
                    this.x -= 15
                    if(this.x < -300) {
                        this.needRemove = true
                    }
                }
            }
        }})
        addPam(pams.FUMESHROOM, 'special', 300, 240, {userAction: function(pamSprite) {
            let shot = addPam(pams.FUMESHROOM_BUBBLES, 'special', pamSprite.x + 130, pamSprite.y, {onFinish: onFinish})
            shot.pamParent = pamSprite
        }})
        addPam(pams.COCONUTCANNON, 'attack', 50, 360, {userAction: function(pamSprite) {
            let shot = addPam(pams.T_COCONUT_PROJECTILE_EXPLOSION, 'coconut_projectile2', pamSprite.x + 80, pamSprite.y - 40)
            shot.stepAction = function() {
                this.x += 50
                if(this.x > 700) {
                    this.needRemove = true
                    let exp = addPam(pams.T_COCONUT_PROJECTILE_EXPLOSION, 'coconut_explosion2', this.x + 40, this.y - 20, {onFinish: onFinish})
                }
            }
        }})

        addPam(pams.SNAPDRAGON, 'attack', 420, 340, {userAction: function(pamSprite) {
            let shot = addPam(pams.SNAPDRAGON_FIRE, 'animation', pamSprite.x + 40, pamSprite.y - 30, {onFinish: onFinish})
            shot.pamParent = pamSprite
        }})

        let zombie2 = addPam(pams.ZOMBIE_EGYPT_BASIC, 'walk', 600, 0, {walk: true, walkGround: 'ground_swatch'})
        let zombie = addPam(pams.ZOMBIE_MODERN_ALLSTAR, 'run', 600, 100, {walk: true, walkGround: 'ground_swatch'})
        
        // addPam(pams.ZOMBIE_EGYPT_BASIC, '_particles', 500, 700)
        // addPam(pams.GARGANTUAR, 'walk', 600, 200, {walk: true, walkGround: 'ground_swatch'})
        // addSprite(pams.PEASHOOTER.image[13].texture, 0, 0)
        // addSprite(pams.PEASHOOTER.image[15].texture, 100, 0)
        // addSprite(pams.PEASHOOTER.image[17].texture, 200, 0)
        // addSprite(pams.SUNFLOWER.image[16].texture, 300, 0)
        // let showpam = pams.T_COCONUT_PROJECTILE_EXPLOSION
        // for(let j = 0;j < 3;j++) {
        //     for(let i = 0;i < 10;i++) {
        //         if(showpam.sprite.length <= i+10*j) continue
        //         addPam(showpam, showpam.sprite[i+10*j].name, i * 100, 800 + j * 80)
        //     }
        // }
        // addPam(pams.SNOWPEA, 'snowpea_spit', 0, 0)
        // addPam(pams.SNOWPEA, 'snowpea_spit', 0, 0)
        // for(let j = 0;j < 3;j++) {
        //     for(let i = 0;i < 10;i++) {
        //         addSprite(pams.T_COCONUT_PROJECTILE_EXPLOSION.image[i + j * 10].texture, i * 100, 800 + j * 80)
        //     }
        // }
        for(let j = 0;j < 5;j++) {
            for(let i = 0;i < 16;i++) {
                let textures = Object.values(resources.UI_SeedPackets_768_00.textures)
                let a = addSprite(textures[i + j * 10], i * 100 + 50, 750 + j * 80)
                a.scale.set(1)
            }
        }
        // addSprite(pams.ZOMBIE_EGYPT_BASIC.image[17].texture, 300, 0)
        app.ticker.add(delta => loop())
        
    }
    var speed = 2
    var intv = 0
    function loop() {
        objects.forEach(a => {
            if(a.needRemove || a.pamParant && a.pamParent.needRemove) {
                stage.removeChild(a)
            }
        })
        objects = objects.filter(a => !a.needRemove && (!a.pamParent || !a.pamParent.needRemove))
        intv++
        if(intv > speed) {
            intv = 0
            for(let p of objects) {
                if(p.visible) {
                    p.step()
                }
                if(p.stepAction) {
                    p.stepAction()
                }
                if(p.param.walk) {
                    if(p.x < -400) {
                        p.x = 900
                    }
                }
            }
            if(sod.parts[27]) {
                grass.width = sod.parts[27].x * 0.91 + 15// - grass.x
            } else {
                grass.width = 1050
            }
            grass2.width = grass.width
        }
    }

    function addPam(pam, act, x, y, custom) {
        // if(pam != pams.BLOOMERANG_PROJECTILE) return {}
        let a
        if(pam.spriteMap[act]) {
            a = new PamSprite(pam, pam.spriteMap[act])
        } else {
            a = new PamSprite(pam, pam.main_sprite, pam.actionFrame[act], custom)
        }
        a.position.set(x, y)
        stage.addChild(a)
        objects.push(a)
        return a
    }

    
    function addSprite(tex, x, y) {
        let a = new PIXI.Sprite(tex)
        a.position.set(x, y)
        stage.addChild(a)
        return a
    }

    function onFinish(pamSprite) {
        pamSprite.visible = false
        pamSprite.needRemove = true
    }
    window.onkeydown = function(e) {
        // e.code : ArrowUp(上), ArrowDown(下), ArrowLeft(左), ArrowRight(右), Space(空格), KeyA(字母A)
        // a = add(tex1.RedAppleLeft, rnd(0, 900 ), rnd(0, 600 ))
        // if(e.code == 'ArrowLeft'){
        // a = addText('周文昊', rnd(0, 900 ), rnd(0, 600 ))
        // a.rotation = rnd(0, 360) /180 * Math.PI
        // a.vx = speed*Math.cos(a.rotation)
        // a.vy = speed*Math.sin(a.rotation)
        // aa.push(a)
        // }


        if(e.code == 'KeyA'){
            speed = 22
        }
        if(e.code == 'KeyR'){
            speed = 2
        }
    }
        </script>
    </body>
</html>